{% load static %}
{% load format_filters %}
<!DOCTYPE html>
<html>
<head>
    <title>Calculateur de Salaires - Guin√©e</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .header-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .result-gradient {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
        }
        .form-card {
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .prime-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        .prime-title {
            color: #495057;
            font-weight: 600;
            margin-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-5">
           <div class="header-gradient text-center">
               <div class="d-flex justify-content-center align-items-center mb-3">
                   {% if company_logo %}
                       <img src="{{ company_logo }}" alt="{{ company_name }}" class="me-3" style="max-height: 60px; max-width: 200px; object-fit: contain;">
                   {% endif %}
                   <div>
                       <h1 class="mb-0">{{ company_name }}</h1>
                       <small class="opacity-75">Calculateur de Salaires Guin√©e</small>
                   </div>
               </div>
               <p class="mb-0">Calculs conformes aux r√®gles fiscales et sociales guin√©ennes</p>
               <small>üí° Saisissez uniquement le salaire net souhait√© - Le syst√®me propose automatiquement les autres valeurs</small>
           </div>
    
    <div class="card form-card shadow p-4">
        <div class="alert alert-info mb-4" role="alert">
            <h6 class="alert-heading">Mode 100% Automatique Activ√©</h6>
            <p class="mb-0">Vous n'avez qu'√† saisir le <strong>salaire net souhait√©</strong>. Le syst√®me calcule automatiquement les <strong>primes taxables √† 25%</strong> avec des pourcentages intelligents adapt√©s au niveau de salaire. Le salaire brut = salaire de base + primes uniquement.</p>
        </div>
        
        <!-- Messages -->
        {% if messages %}
        <div class="row mb-4">
            <div class="col-12">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <form method="post" id="salaryForm">
            {% csrf_token %}
            
            <!-- Nom complet et Salaire net c√¥te √† c√¥te -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label fw-bold fs-5">üë§ Nom complet de l'employ√© :</label>
                    {{ form.nom_complet }}
                    <div class="form-text">Pr√©nom et nom de famille</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold fs-5">üí∞ Salaire net souhait√© :</label>
                    {{ form.net_salary }}
                    <div class="form-text">Montant du salaire net souhait√©</div>
                </div>
            </div>
            
            <!-- Section Primes Exon√©r√©es -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">üèÜ Primes (Taxables) - Calcul√©es automatiquement</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                {{ form.has_exempt_primes }}
                                <label class="form-check-label fw-bold" for="{{ form.has_exempt_primes.id_for_label }}">
                                    {{ form.has_exempt_primes.label }}
                                </label>
                                <div class="form-text">Cochez si l'employ√© a des primes exon√©r√©es d'imp√¥ts</div>
                            </div>
                            
                            <div id="exempt-primes-section" style="display: none;">
                                <div class="alert alert-info">
                                    <strong>üí° Calcul Automatique :</strong> Les montants des primes exon√©r√©es sont calcul√©s automatiquement par l'algorithme pour optimiser les performances.
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            {{ form.prime_retraite }}
                                            <label class="form-check-label" for="{{ form.prime_retraite.id_for_label }}">
                                                {{ form.prime_retraite.label }}
                                            </label>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                Montant calcul√© : 
                                                <span class="fw-bold text-success" id="prime_retraite_amount">
                                                    {% if exempt_primes_amounts.prime_retraite %}{{ exempt_primes_amounts.prime_retraite|format_currency }}{% else %}Calcul√© automatiquement{% endif %}
                                                </span>
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            {{ form.prime_interim }}
                                            <label class="form-check-label" for="{{ form.prime_interim.id_for_label }}">
                                                {{ form.prime_interim.label }}
                                            </label>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                Montant calcul√© : 
                                                <span class="fw-bold text-success" id="prime_interim_amount">
                                                    {% if exempt_primes_amounts.prime_interim %}{{ exempt_primes_amounts.prime_interim|format_currency }}{% else %}Calcul√© automatiquement{% endif %}
                                                </span>
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            {{ form.prime_anciennete }}
                                            <label class="form-check-label" for="{{ form.prime_anciennete.id_for_label }}">
                                                {{ form.prime_anciennete.label }}
                                            </label>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                Montant calcul√© : 
                                                <span class="fw-bold text-success" id="prime_anciennete_amount">
                                                    {% if exempt_primes_amounts.prime_anciennete %}{{ exempt_primes_amounts.prime_anciennete|format_currency }}{% else %}Calcul√© automatiquement{% endif %}
                                                </span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3 p-3 bg-light rounded">
                                    <h6 class="mb-2">üìä Total des Primes Exon√©r√©es :</h6>
                                    <div class="h5 text-primary" id="total_exempt_primes">
                                        {% if result.primes_exonerees %}{{ result.primes_exonerees|format_currency }}{% else %}0 GNF{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                   
                   <!-- Primes taxables (calcul√©es automatiquement) -->
                   <div class="prime-section ">
                       <div class="prime-title bg-warning text-dark">‚ö†Ô∏è Primes Non Taxables - Calcul√©es automatiquement</div>
                       <div class="row">
                           <div class="col-md-6 mb-3">
                               <label class="form-label">Prime de chert√© de vie :</label>
                               <div class="form-control" style="background-color: #e8f5e8; border: 2px solid #28a745;">
                                   <span data-prime="prime_cherte_vie">{% if primes_auto %}{{ primes_auto.prime_cherte_vie|format_currency }}{% else %}Calcul√© automatiquement{% endif %}</span>
                               </div>
                           </div>
                           <div class="col-md-6 mb-3">
                               <label class="form-label">Indemnit√© de logement :</label>
                               <div class="form-control" style="background-color: #e8f5e8; border: 2px solid #28a745;">
                                   <span data-prime="indemnite_logement">{% if primes_auto %}{{ primes_auto.indemnite_logement|format_currency }}{% else %}Calcul√© automatiquement{% endif %}</span>
                               </div>
                           </div>
                           <div class="col-md-6 mb-3">
                               <label class="form-label">Indemnit√© de transport :</label>
                               <div class="form-control" style="background-color: #e8f5e8; border: 2px solid #28a745;">
                                   <span data-prime="indemnite_transport">{% if primes_auto %}{{ primes_auto.indemnite_transport|format_currency }}{% else %}Calcul√© automatiquement{% endif %}</span>
                               </div>
                           </div>
                           <div class="col-md-6 mb-3">
                               <label class="form-label">Indemnit√© de repas/panier :</label>
                               <div class="form-control" style="background-color: #e8f5e8; border: 2px solid #28a745;">
                                   <span data-prime="indemnite_repas">{% if primes_auto %}{{ primes_auto.indemnite_repas|format_currency }}{% else %}Calcul√© automatiquement{% endif %}</span>
                               </div>
                           </div>
                       </div>
                       <small class="text-muted">
                           <strong>ü§ñ Calcul automatique :</strong> Ces montants sont calcul√©s automatiquement en fonction du salaire net saisi. 
                           <strong>R√®gle fiscale :</strong> Si 25% du salaire brut - primes taxables > 0, 
                           alors la diff√©rence devient l'√©cart imposable.
                       </small>
                   </div>
            
            <!-- Section D√©ductions -->
            <div class="mt-4 p-3" style="background-color: #fff3cd; border: 2px solid #ffc107; border-radius: 10px;">
                <h6 class="fw-bold mb-3 text-warning">üí∏ D√©ductions pour le Salaire Net √† Payer</h6>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Avance sur salaire :</label>
                        {{ form.avance_salaire }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Saisie et opposition :</label>
                        {{ form.saisie_opposition }}
                    </div>
                </div>
                <small class="text-muted">
                    <strong>üí° Note :</strong> Ces montants seront d√©duits du salaire net pour calculer le salaire net √† payer.
                </small>
            </div>
            
            <button type="submit" class="btn btn-primary w-100 btn-lg mt-4">
                üßÆ Calculer le Salaire de Base
            </button>
        </form>
    </div>

    {% if result %}
    <div class="card result-gradient shadow p-4 mt-4">
        <h4 class="text-center mb-4">üìä R√©sultat du Calcul Complet</h4>
        
        <!-- Premi√®re ligne : Salaire de base, Primes, Salaire brut, Salaire imposable -->
        <div class="row mb-4">
            <div class="col-12">
                <h6 class="fw-bold mb-3 text-center">üí∞ Calculs Principaux</h6>
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Salaire de Base</h6>
                                <h4 class="text-primary">{{ result.basic|format_currency }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">üìä D√©tails des Primes</h6>
                                <div class="text-start">
                                    <div class="mb-2">
                                        <small class="text-muted">Total Primes Taxables :</small><br>
                                        <strong class="text-warning">{{ result.primes_taxables|format_currency }}</strong>
                                    </div>
                                    <div>
                                        <small class="text-muted">Total Primes Non Taxables :</small><br>
                                        <strong class="text-success">{{ result.primes_exonerees|format_currency }}</strong>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">√âcart Imposable :</small><br>
                                        <strong class="text-danger">{{ result.ecart_imposable|format_currency }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Salaire Brut</h6>
                                <h4 class="text-info">{{ result.gross|format_currency }}</h4>
                                <small class="text-muted">Base + Toutes les Primes</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Salaire Imposable</h6>
                                <h4 class="text-warning">{{ result.imposable|format_currency }}</h4>
                                <small class="text-muted">Brut - CNSS + √âcart</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Deuxi√®me ligne : Salaire net, D√©ductions, Net √† payer -->
        <div class="row mb-4">
            <div class="col-12">
                <h6 class="fw-bold mb-3 text-center">üí∏ Salaire Net et D√©ductions</h6>
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Salaire Net</h6>
                                <h4 class="text-success">{{ result.net|format_currency }}</h4>
                                <small class="text-muted">Imposable - RTS</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">üí∏ D√©ductions</h6>
                                <div class="text-start">
                                    <div class="mb-2">
                                        <small class="text-muted">Avance sur salaire :</small><br>
                                        <strong class="text-warning">{{ avance_salaire|abs_value|format_currency }}</strong>
                                    </div>
                                    <div>
                                        <small class="text-muted">Saisie et opposition :</small><br>
                                        <strong class="text-warning">{{ saisie_opposition|abs_value|format_currency }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">üí∞ Net √† Payer</h6>
                                <h4 class="text-primary">{{ salaire_net_a_payer|format_currency }}</h4>
                                <small class="text-muted">Net - D√©ductions</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charges Employ√© -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h6 class="fw-bold mb-3 text-danger">üë§ Charges Employ√©</h6>
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between">
                        <span>CNSS Employ√© (5%)</span>
                        <strong>{{ result.cnss|format_currency }}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>RTS</span>
                        <strong>{{ result.rts|format_currency }}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between bg-danger text-white">
                        <span><strong>TOTAL CHARGES EMPLOY√â</strong></span>
                        <strong>{{ result.total_charges_employee|format_currency }}</strong>
                    </li>
                </ul>
            </div>

            <!-- Charges Employeur -->
            <div class="col-md-6">
                <h6 class="fw-bold mb-3 text-warning">üè¢ Charges Employeur</h6>
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between">
                        <span>CNSS Employeur (18%)</span>
                        <strong>{{ result.cnss_employer|format_currency }}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Versement Forfaitaire (6%)</span>
                        <strong>{{ result.versement_forfaitaire|format_currency }}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Taxe d'Apprentissage (2%)</span>
                        <strong>{{ result.taxe_apprentissage|format_currency }}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between bg-warning text-dark">
                        <span><strong>TOTAL CNSS PATRONAL</strong></span>
                        <strong>{{ result.total_cnss_patronal|format_currency }}</strong>
                    </li>
                </ul>
            </div>
        </div>

        <!-- D√©tail RTS -->
        <div class="row mb-4">
            <div class="col-12">
                <h6 class="fw-bold mb-3 text-info">üìà D√©tail du Calcul RTS</h6>
                <div class="card bg-light">
                    <div class="card-body">
                        <p class="mb-3"><strong>Base imposable :</strong> {{ result.imposable|format_currency }}</p>
                        {% if result.rts > 0 %}
                        <div class="alert alert-info">
                            <h6 class="alert-heading">Calcul par tranches :</h6>
                            <ul class="mb-0">
                                {% for detail in result.rts_details %}
                                <li>{{ detail|safe }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% else %}
                        <div class="alert alert-success">
                            <h6 class="alert-heading">‚úÖ Aucune RTS due</h6>
                            <p class="mb-0">Votre salaire imposable est inf√©rieur au seuil d'imposition de 1,000,000 GNF.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Informations suppl√©mentaires -->
        <div class="row">
            <div class="col-md-6">
                <h6 class="fw-bold mb-3">üìã Informations Suppl√©mentaires</h6>
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Salaire Brut</span>
                        <strong>{{ result.gross|format_currency }}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Total Primes Exon√©r√©es</span>
                        <strong>{{ result.primes_taxables|format_currency }}</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>√âcart Imposable</span>
                        <strong>{{ result.ecart_imposable|format_currency }}</strong>
                    </li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6 class="fw-bold mb-3">üí° R√®gles Appliqu√©es</h6>
                <div class="alert alert-info">
                    <small>
                        <strong>R√®gle des 25% :</strong> Si les primes Exon√©r√©es d√©passent 25% du salaire brut, 
                        la diff√©rence devient l'√©cart imposable.<br>
                        <strong>Base imposable :</strong> Salaire brut - CNSS + √âcart imposable
                    </small>
                </div>
            </div>
        </div>
        
        {% if result.ecart_imposable > 0 %}
        <div class="alert alert-warning mt-3" role="alert">
            <strong>‚ö†Ô∏è Attention :</strong> Un √©cart imposable de {{ result.ecart_imposable|floatformat:0 }} GNF a √©t√© calcul√© 
            selon la r√®gle des 25% pour √©viter une r√©partition illicite des primes.
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Liste des employ√©s -->
    {% if employees %}
    <div class="card mt-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-users"></i> Derniers Employ√©s Ajout√©s</h5>
        </div>
        <div class="card-body">
                   <div class="row mb-3">
                       <div class="col-md-6">
                           <span class="badge bg-info fs-6">Total: {{ employees|length }} employ√©{{ employees|length|pluralize }}</span>
                       </div>
                       <div class="col-md-6 text-end">
                           <a href="{% url 'export_excel' %}" class="btn btn-success me-2">
                               <i class="fas fa-file-excel"></i> Exporter Excel
                           </a>
                           {% if employees %}
                           <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                               <i class="fas fa-trash"></i> Supprimer Tout
                           </button>
                           {% endif %}
                       </div>
                   </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Nom Complet</th>
                            <th>Salaire Net</th>
                            <th>Salaire Brut</th>
                            <th>Co√ªt Total</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in employees %}
                        <tr>
                            <td><strong>{{ employee.nom_complet }}</strong></td>
                            <td>{{ employee.salaire_net|format_currency }}</td>
                            <td>{{ employee.salaire_brut|format_currency }}</td>
                            <td class="text-success"><strong>{{ employee.get_total_cout_employeur|format_currency }}</strong></td>
                            <td>{{ employee.date_creation|date:"d/m/Y H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Animation pour les sections de primes
document.addEventListener('DOMContentLoaded', function() {
    const primeSections = document.querySelectorAll('.prime-section');
    primeSections.forEach(section => {
        section.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.transition = 'transform 0.3s ease';
        });
        section.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
    
    // Calcul automatique des primes en temps r√©el
    const netSalaryInput = document.querySelector('input[name="net_salary"]');
    if (netSalaryInput) {
        netSalaryInput.addEventListener('input', function() {
            const netSalary = parseFloat(this.value) || 0;
            if (netSalary > 0) {
                calculatePrimesAutomatiques(netSalary);
            }
        });
    }
    
    // Gestion de l'affichage des primes exon√©r√©es
    const hasExemptPrimesCheckbox = document.querySelector('input[name="has_exempt_primes"]');
    const exemptPrimesSection = document.getElementById('exempt-primes-section');
    const exemptPrimeCheckboxes = document.querySelectorAll('.exempt-prime');
    
    if (hasExemptPrimesCheckbox) {
        hasExemptPrimesCheckbox.addEventListener('change', function() {
            if (this.checked) {
                exemptPrimesSection.style.display = 'block';
                exemptPrimeCheckboxes.forEach(checkbox => {
                    checkbox.disabled = false;
                });
                calculateExemptPrimes();
            } else {
                exemptPrimesSection.style.display = 'none';
                exemptPrimeCheckboxes.forEach(checkbox => {
                    checkbox.disabled = true;
                    checkbox.checked = false;
                });
                clearExemptPrimesDisplay();
            }
        });
    }
    
    // Ajouter des listeners aux checkboxes des primes exon√©r√©es
    exemptPrimeCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', calculateExemptPrimes);
    });
});

function calculatePrimesAutomatiques(netSalary) {
    // Calcul des primes en pourcentage du salaire net
    let prime_cherte_vie, indemnite_logement, indemnite_transport, indemnite_repas;
    
    if (netSalary <= 200000) {  // Salaire bas
        prime_cherte_vie = netSalary * 0.03;      // 3%
        indemnite_logement = netSalary * 0.05;    // 5%
        indemnite_transport = netSalary * 0.03;   // 3%
        indemnite_repas = netSalary * 0.02;       // 2%
    } else if (netSalary <= 500000) {  // Salaire moyen
        prime_cherte_vie = netSalary * 0.04;      // 4%
        indemnite_logement = netSalary * 0.06;    // 6%
        indemnite_transport = netSalary * 0.04;   // 4%
        indemnite_repas = netSalary * 0.03;       // 3%
    } else if (netSalary <= 1000000) {  // Salaire √©lev√©
        prime_cherte_vie = netSalary * 0.05;      // 5%
        indemnite_logement = netSalary * 0.08;    // 8%
        indemnite_transport = netSalary * 0.05;   // 5%
        indemnite_repas = netSalary * 0.04;       // 4%
    } else {  // Salaire tr√®s √©lev√©
        prime_cherte_vie = netSalary * 0.06;      // 6%
        indemnite_logement = netSalary * 0.10;    // 10%
        indemnite_transport = netSalary * 0.06;   // 6%
        indemnite_repas = netSalary * 0.05;       // 5%
    }
    
    // Mettre √† jour l'affichage des primes
    updatePrimeDisplay('prime_cherte_vie', Math.round(prime_cherte_vie));
    updatePrimeDisplay('indemnite_logement', Math.round(indemnite_logement));
    updatePrimeDisplay('indemnite_transport', Math.round(indemnite_transport));
    updatePrimeDisplay('indemnite_repas', Math.round(indemnite_repas));
}

function updatePrimeDisplay(primeType, value) {
    const elements = document.querySelectorAll(`[data-prime="${primeType}"]`);
    elements.forEach(element => {
        element.textContent = formatNumber(value) + ' GNF';
    });
}

function formatNumber(value) {
    return value.toLocaleString('fr-FR').replace(/,/g, ' ');
}

function calculateExemptPrimes() {
    const netSalaryInput = document.querySelector('input[name="net_salary"]');
    const netSalary = parseFloat(netSalaryInput.value) || 0;
    
    if (netSalary <= 0) return;
    
    // Calculer le montant de base (5% du salaire net)
    const baseAmount = netSalary * 0.05;
    
    // R√©cup√©rer les primes s√©lectionn√©es
    const selectedPrimes = [];
    const primeRetraite = document.querySelector('input[name="prime_retraite"]');
    const primeInterim = document.querySelector('input[name="prime_interim"]');
    const primeAnciennete = document.querySelector('input[name="prime_anciennete"]');
    
    if (primeRetraite && primeRetraite.checked) selectedPrimes.push('retraite');
    if (primeInterim && primeInterim.checked) selectedPrimes.push('interim');
    if (primeAnciennete && primeAnciennete.checked) selectedPrimes.push('anciennete');
    
    if (selectedPrimes.length === 0) {
        clearExemptPrimesDisplay();
        return;
    }
    
    // Calculer le montant par prime
    const amountPerPrime = baseAmount / selectedPrimes.length;
    
    // Coefficients pour chaque type de prime
    const coefficients = {
        'retraite': 1.2,
        'interim': 0.8,
        'anciennete': 1.0
    };
    
    let totalExempt = 0;
    
    // Calculer et afficher chaque prime
    if (primeRetraite && primeRetraite.checked) {
        const amount = amountPerPrime * coefficients.retraite;
        document.getElementById('prime_retraite_amount').textContent = formatNumber(amount) + ' GNF';
        totalExempt += amount;
    } else {
        document.getElementById('prime_retraite_amount').textContent = 'Calcul√© automatiquement';
    }
    
    if (primeInterim && primeInterim.checked) {
        const amount = amountPerPrime * coefficients.interim;
        document.getElementById('prime_interim_amount').textContent = formatNumber(amount) + ' GNF';
        totalExempt += amount;
    } else {
        document.getElementById('prime_interim_amount').textContent = 'Calcul√© automatiquement';
    }
    
    if (primeAnciennete && primeAnciennete.checked) {
        const amount = amountPerPrime * coefficients.anciennete;
        document.getElementById('prime_anciennete_amount').textContent = formatNumber(amount) + ' GNF';
        totalExempt += amount;
    } else {
        document.getElementById('prime_anciennete_amount').textContent = 'Calcul√© automatiquement';
    }
    
    // Afficher le total
    document.getElementById('total_exempt_primes').textContent = formatNumber(totalExempt) + ' GNF';
}

function clearExemptPrimesDisplay() {
    document.getElementById('prime_retraite_amount').textContent = 'Calcul√© automatiquement';
    document.getElementById('prime_interim_amount').textContent = 'Calcul√© automatiquement';
    document.getElementById('prime_anciennete_amount').textContent = 'Calcul√© automatiquement';
    document.getElementById('total_exempt_primes').textContent = '0 GNF';
}
</script>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Confirmation de suppression
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">
                    <strong>‚ö†Ô∏è Attention !</strong> Cette action va supprimer <strong>TOUS</strong> les enregistrements d'employ√©s de la base de donn√©es.
                </p>
                <p class="mb-3">
                    <strong>Nombre d'employ√©s √† supprimer :</strong> <span class="badge bg-danger fs-6">{{ employees|length }}</span>
                </p>
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Cette action est irr√©versible !</strong> Assurez-vous d'avoir export√© vos donn√©es avant de continuer.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <form method="post" action="{% url 'delete_all' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Supprimer D√©finitivement
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
